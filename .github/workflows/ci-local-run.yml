name: WireGuard example

on:
  push:
    branches:
      - testing

jobs:
  wireguard_example:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install WireGuard
        shell: pwsh
        run: |
          # Download the latest WireGuard installer
          $url = "https://download.wireguard.com/windows-client/wireguard-installer.exe"
          $installerPath = "$env:TEMP\wireguard-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $installerPath

          # Install silently (no GUI, no prompts)
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow

          # Verify installation
          if (!(Test-Path "C:\Program Files\WireGuard\wireguard.exe")) {
            Write-Error "WireGuard installation failed"
            exit 1
          }

      - name: Write WireGuard config file
        shell: pwsh
        run: |
          $configContent = @"
          [Interface]
          PrivateKey = ${{ secrets.WIREGUARD_PRIVATE_KEY }}
          Address = 10.0.0.2/24
          DNS = 8.8.8.8, 8.8.4.4

          [Peer]
          PublicKey = gTecIYqs7cW7SyHzS3lwy7MK/Lf9G0MxYg2YhAN90lw=
          AllowedIPs = 0.0.0.0/0
          Endpoint = 114.143.100.202:51820
          PersistentKeepalive = 25
          "@

          $configPath = "$env:TEMP\wg0.conf"
          Set-Content -Path $configPath -Value $configContent -Encoding UTF8

      - name: Install and start WireGuard tunnel
        shell: pwsh
        run: |
          $wgExe = "C:\Program Files\WireGuard\wireguard.exe"
          $configPath = "$env:TEMP\wg0.conf"

          # Install tunnel as a Windows service
          Start-Process -FilePath $wgExe -ArgumentList "/installtunnelservice", $configPath -Wait -NoNewWindow

          # Give it a few seconds to start
          Start-Sleep -Seconds 10

      - name: Verify WireGuard status
        shell: pwsh
        run: |
          # Show status using wg.exe (WireGuard tools include wg.exe on Windows too)
          $wgPath = "C:\Program Files\WireGuard\wg.exe"
          if (Test-Path $wgPath) {
            & $wgPath show
          } else {
            Write-Warning "wg.exe not found - using netsh to check adapter"
          }

          # Alternative: Check if the adapter exists
          Get-NetAdapter | Where-Object { $_.Name -like "*wg0*" }

      - name: Test connectivity
        shell: pwsh
        run: |
          curl -v https://172.16.0.200