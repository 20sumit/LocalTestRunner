name: CI - Build & Installer on Self-Hosted Runner

on:
  push:
    branches:
      - testing
      
jobs:
  build-and-installer:
    name: Build and Create Installer (Self-Hosted)
    runs-on: [self-hosted, Windows, X64]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build project (Release)
        shell: cmd
        run: |
          "C:\Program Files\dotnet\dotnet.exe" build LocalTestRunner.sln -c Release

      - name: List build output
        shell: cmd
        run: |
          dir bin\Release\net8.0 /s

      - name: Clean installer bin folder
        shell: cmd
        run: |
          if exist E:\test\bin (
            rmdir /s /q E:\test\bin
          )
          mkdir E:\test\bin

      - name: Copy binaries to installer bin
        shell: cmd
        run: |
          xcopy bin\Release\net8.0\* E:\test\bin\ /e /i /y

      - name: Build installer
        shell: cmd
        run: |
          "C:\Program Files (x86)\Caphyon\Advanced Installer 22.9.1\bin\x86\AdvancedInstaller.com" /build "E:\test\Advanced Installer\Projects\Vm Testing\Vm Testing.aip"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: E:\test\Advanced Installer\Projects\Vm Testing\Setup Files\*.exe
