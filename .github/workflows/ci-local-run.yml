name: CI - Build & Installer on Self-Hosted Runner

on:
  push:
    branches:
      - testing

jobs:
  build-and-installer:
    name: Build and Create Installer (Self-Hosted)
    runs-on: [self-hosted, Windows, X64]

    steps:
      #  Checkout source code
      - name: Checkout source
        uses: actions/checkout@v4

      #  Setup .NET SDK (ensures dotnet command works)
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      #  Build project in Release mode (using cmd shell to avoid PS issues)
      - name: Build project (Release)
        run: dotnet build LocalTestRunner.sln -c Release
        shell: cmd

      #  List build output (optional, debug)
      - name: List build output
        run: dir bin\Release\net8.0 /s
        shell: cmd

      #  Clean installer bin folder
      - name: Clean installer bin folder
        run: |
          Remove-Item 'C:\Users\Admin\Documents\bin\*' -Recurse -Force -ErrorAction SilentlyContinue
        shell: pwsh

      #  Copy build output to installer bin
      - name: Copy binaries to installer bin
        run: |
          Copy-Item `
            -Path 'bin\Release\net8.0\*' `
            -Destination 'C:\Users\Admin\Documents\bin' `
            -Recurse -Force
        shell: pwsh

      #  Build installer using Advanced Installer
      - name: Build installer
        run: |
          $aiPath = "C:\Program Files (x86)\Caphyon\Advanced Installer 22.9.1\bin\x86\AdvancedInstaller.com"
          $projectPath = "C:\Users\Admin\Documents\VM Runner Test.aip"

          & "$aiPath" /build "$projectPath"
        shell: pwsh

      #  Upload the generated installer as artifact
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: C:\Users\Admin\Documents\Setup Files\*.exe
