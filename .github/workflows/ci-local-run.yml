name: Hybrid CI - Build on GitHub VM & Installer on Self-Hosted

# Trigger workflow on push to testing branch
on:
  push:
    branches:
      - testing

jobs:
  build-on-github-vm:
    name: Build on GitHub-hosted VM
    runs-on: windows-latest

    steps:
      # Checkout source code
      - name: Checkout source
        uses: actions/checkout@v4

      # Build project in Release mode
      - name: Build project (Release)
        run: dotnet build LocalTestRunner.sln -c Release
        shell: powershell

      # List build output for debugging (optional)
      - name: List build output
        run: dir LocalTestRunner/bin/Release/net8.0 -Recurse
        shell: powershell

      # Upload build binaries as artifact
      - name: Upload build binaries
        uses: actions/upload-artifact@v4
        with:
          name: build-binaries
          path: LocalTestRunner/bin/Release/net8.0/**

  build-installer-on-self-hosted:
    name: Build Installer on Self-Hosted Runner
    needs: build-on-github-vm
    runs-on: [self-hosted, Windows, X64]

    steps:
      # Download build artifacts from GitHub VM
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-binaries
          path: temp-bin

      # Clean existing Advanced Installer bin folder
      - name: Clean Advanced Installer bin folder
        run: Remove-Item 'E:\AIPProject\bin\*' -Recurse -Force -ErrorAction SilentlyContinue
        shell: powershell

      # Copy binaries from artifact to Advanced Installer bin
      - name: Copy binaries to Advanced Installer bin
        run: Copy-Item -Path 'temp-bin\*' -Destination 'E:\AIPProject\bin' -Recurse -Force
        shell: powershell

      # Build installer using Advanced Installer (floating license)
      - name: Build installer
        run: |
          & 'C:\Program Files (x86)\Caphyon\Advanced Installer\bin\x86\AdvancedInstaller.com' /build 'E:\AIPProject\test.aip' /log 'E:\AIPProject\ai_build.log'
        shell: powershell

      # Upload the generated installer as artifact
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            E:\AIPProject\*.exe
            E:\AIPProject\*.msi
