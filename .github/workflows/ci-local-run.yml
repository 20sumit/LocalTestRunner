name: WireGuard example with Advanced Installer

on:
  push:
    branches:
      - testing

jobs:
  wireguard_example:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build the code
        shell: pwsh
        run: |
          # Placeholder: Build your code (e.g., using MSBuild for a .sln solution)
          # Adjust based on your project type (e.g., dotnet build, cmake, etc.)
          if (Test-Path "*.sln") {
            msbuild /p:Configuration=Release /p:Platform=x64
          } else {
            Write-Warning "No .sln found - add your build command here"
          }

      - name: Install WireGuard
        shell: pwsh
        run: |
          # Download the latest WireGuard installer
          $url = "https://download.wireguard.com/windows-client/wireguard-installer.exe"
          $installerPath = "$env:TEMP\wireguard-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $installerPath

          # Install silently (no GUI, no prompts)
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow

          # Verify installation
          if (!(Test-Path "C:\Program Files\WireGuard\wireguard.exe")) {
            Write-Error "WireGuard installation failed"
            exit 1
          }

      - name: Write WireGuard config file
        shell: pwsh
        run: |
          $configContent = @"
          [Interface]
          PrivateKey = ${{ secrets.WIREGUARD_PRIVATE_KEY }}
          Address = 10.0.0.2/24
          DNS = 8.8.8.8, 8.8.4.4

          [Peer]
          PublicKey = gTecIYqs7cW7SyHzS3lwy7MK/Lf9G0MxYg2YhAN90lw=
          AllowedIPs = 0.0.0.0/0
          Endpoint = 114.143.100.202:51820
          PersistentKeepalive = 25
          "@

          $configPath = "$env:TEMP\wg0.conf"
          Set-Content -Path $configPath -Value $configContent -Encoding UTF8

      - name: Install and start WireGuard tunnel
        shell: pwsh
        run: |
          $wgExe = "C:\Program Files\WireGuard\wireguard.exe"
          $configPath = "$env:TEMP\wg0.conf"

          # Install tunnel as a Windows service
          Start-Process -FilePath $wgExe -ArgumentList "/installtunnelservice", $configPath -Wait -NoNewWindow

          # Give it a few seconds to start
          Start-Sleep -Seconds 10

      - name: Install Advanced Installer silently
        shell: pwsh
        run: |
          # Download the latest Advanced Installer MSI
          $url = "https://www.advancedinstaller.com/downloads/advinst.msi"
          $msiPath = "$env:TEMP\advinst.msi"
          Invoke-WebRequest -Uri $url -OutFile $msiPath

          # Install silently
          Start-Process msiexec -ArgumentList "/i `"$msiPath`" /qn" -Wait -NoNewWindow

          # Verify installation
          $aiPath = "C:\Program Files\Caphyon\Advanced Installer\bin\AdvancedInstaller.com"
          if (!(Test-Path $aiPath)) {
            Write-Error "Advanced Installer installation failed"
            exit 1
          }

      - name: Check access to floating license server
        shell: pwsh
        run: |
          $aiPath = "C:\Program Files\Caphyon\Advanced Installer\bin\AdvancedInstaller.com"

          # Register with floating license and test connection
          # This checks if the GitHub VM can access the server via the tunnel
          & $aiPath /registerfloating 172.16.2.20:8080 -testconnection

          # Optional: Basic connectivity test (if license server responds to HTTP/TCP)
          try {
            Invoke-WebRequest -Uri "http://172.16.2.20:8080" -Method Head -TimeoutSec 10
            Write-Output "Basic TCP/HTTP access to 172.16.2.20:8080 succeeded"
          } catch {
            Write-Warning "Basic TCP/HTTP access failed (expected if server doesn't expose HTTP)"
          }

      # Optional: Stop WireGuard tunnel (cleanup)
      - name: Stop WireGuard tunnel
        if: always()
        shell: pwsh
        run: |
          "C:\Program Files\WireGuard\wireguard.exe" /uninstalltunnelservice wg0