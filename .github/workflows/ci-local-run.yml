name: CI - Build & Installer on Self-Hosted Runner

on:
  push:
    branches:
      - testing

jobs:
  build-and-installer:
    name: Build and Create Installer (Self-Hosted)
    runs-on: [self-hosted, Windows, X64]

    steps:
      # Checkout source code
      - name: Checkout source
        uses: actions/checkout@v4

      # Build project in Release mode
      - name: Build project (Release)
        run: dotnet build LocalTestRunner.sln -c Release
        shell: powershell

      # Optional: List build output for debugging
      - name: List build output
        run: dir bin\Release\net8.0 -Recurse
        shell: powershell

      # Clean destination bin folder
      - name: Clean installer bin folder
        run: |
          Remove-Item 'C:\Users\Admin\Documents\bin\*' -Recurse -Force -ErrorAction SilentlyContinue
        shell: powershell

      # Copy build output to installer bin folder
      - name: Copy binaries to installer bin
        run: |
          Copy-Item `
            -Path 'bin\Release\net8.0\*' `
            -Destination 'C:\Users\Admin\Documents\bin' `
            -Recurse -Force
        shell: powershell

      # Build installer using Advanced Installer
      - name: Build installer
        shell: powershell
        run: |
          $aiPath = "C:\Program Files (x86)\Caphyon\Advanced Installer 22.9.1\bin\x86\AdvancedInstaller.com"
          $projectPath = "C:\Users\Admin\Documents\VM Runner Test.aip"

          & "$aiPath" /build "$projectPath"

      # Upload the generated installer as artifact
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            C:\Users\Admin\Documents\Setup Files\*.exe
