name: CI - Build & Installer on Self-Hosted Runner

on:
  push:
    branches:
      - testing

jobs:
  build-and-installer:
    name: Build and Create Installer (Self-Hosted)
    runs-on: [self-hosted, Windows, X64]

    steps:
      # Checkout source code
      - name: Checkout source
        uses: actions/checkout@v4

      # Setup .NET SDK
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # Build project in Release mode
      - name: Build project (Release)
        run: dotnet build LocalTestRunner.sln -c Release
        shell: cmd

      # List build output (debug)
      - name: List build output
        run: dir bin\Release\net8.0 /s
        shell: cmd

      # Clean installer bin folder
      - name: Clean installer bin folder
        shell: pwsh
        run: |
          Remove-Item 'E:\test\bin\*' -Recurse -Force -ErrorAction SilentlyContinue

      # Copy build output to installer bin
      - name: Copy binaries to installer bin
        shell: pwsh
        run: |
          Copy-Item `
            -Path 'bin\Release\net8.0\*' `
            -Destination 'E:\test\bin' `
            -Recurse -Force

      # Build installer using Advanced Installer
      - name: Build installer
        shell: pwsh
        run: |
          $aiPath = "C:\Program Files (x86)\Caphyon\Advanced Installer 22.9.1\bin\x86\AdvancedInstaller.com"
          $projectPath = "E:\test\VM.aip"

          & "$aiPath" /build "$projectPath"

      # Upload installer artifact
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: E:\test\Setup Files\*.exe
