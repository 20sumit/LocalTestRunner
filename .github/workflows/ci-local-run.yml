name: WireGuard VPN Client Test (Ubuntu)

on:
  push:
    branches:
      - testing
       
jobs:
  vpn:
    runs-on: ubuntu-latest

    steps:
      - name: Install WireGuard
        run: |
          sudo apt update
          sudo apt install -y wireguard

      - name: Write private key to temp file
        run: |
          echo "${{ secrets.WG_PRIVATE_KEY }}" > privatekey
          chmod 600 privatekey

      - name: Create WireGuard interface
        run: sudo ip link add dev wg0 type wireguard

      - name: Assign IP address
        run: sudo ip address add dev wg0 10.60.0.2/32

      - name: Configure WireGuard peer
        run: |
          sudo wg set wg0 \
            private-key privatekey \
            peer DZ0/DwS6Nv/8MjyJBFrYi1wke8waSXvL1QDzJH9VmFE= \
            allowed-ips 10.60.0.1/32 \
            endpoint "${{ secrets.WG_SERVER_ENDPOINT }}" \
            persistent-keepalive 25

      - name: Bring interface up
        run: sudo ip link set up dev wg0

      - name: Show VPN status & routes
        run: |
          sudo wg show
          ip addr show wg0
          ip route show table all | grep wg0 || true

      - name: Test connectivity to WireGuard server
        run: |
          echo "Testing tunnel (server tunnel IP):"
          ping -c 3 10.60.0.1 || true

      - name: Tear down WireGuard (cleanup)
        if: always()
        run: |
          sudo ip link delete dev wg0 || true
          rm -f privatekey || true
