name: WireGuard VPN Client Test (Ubuntu)

on:
  workflow_dispatch:

jobs:
  vpn:
    runs-on: ubuntu-latest
    steps:
      - name: Install WireGuard
        run: |
          sudo apt update
          sudo apt install -y wireguard curl

      - name: Write WireGuard config
        run: |
          mkdir -p $HOME/wg
          cat <<'EOF' > $HOME/wg/wg0.conf
[Interface]
PrivateKey = "${{ secrets.WG_PRIVATE_KEY }}"
Address = 10.60.0.2/32
DNS = 1.1.1.1

[Peer]
PublicKey = "${{ secrets.WG_SERVER_PUBLIC_KEY }}"
AllowedIPs = "${{ secrets.WG_ALLOWED_IPS }}"
Endpoint = "${{ secrets.WG_SERVER_ENDPOINT }}"
PersistentKeepalive = 25
EOF

      - name: Bring up WireGuard
        run: |
          sudo wg-quick up $HOME/wg/wg0.conf

      - name: Show VPN status
        run: |
          sudo wg show
          ip addr show wg0

      - name: Test private network access
        run: |
          ping -c 2 192.168.1.10
          curl -v http://192.168.1.10:8080

      - name: Tear down WireGuard
        if: always()
        run: |
          sudo wg-quick down $HOME/wg/wg0.conf
