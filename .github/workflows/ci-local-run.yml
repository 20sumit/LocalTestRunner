name: Tailscale CI

on:
  push:
    branches:
      - testing

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # Step 1: Connect to Tailscale using the GitHub Action
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}
          tags: tag:ci

      # Step 2: Get the Tailscale IP of the target node
      - name: Resolve node IP
        id: get_ip
        run: |
          $targetName = "PTPL-281"
          $status = tailscale status --json | ConvertFrom-Json
          $node = $status.Machines | Where-Object { $_.Name -eq $targetName }
          if (-not $node) {
            Write-Host "Node $targetName not found in Tailnet!"
            exit 1
          }
          Write-Host "Node IP: $($node.Addresses[0])"
          echo "TARGET_IP=$($node.Addresses[0])" >> $env:GITHUB_ENV

      # Step 3: Ping the node (fallback to IP)
      - name: Ping node
        run: |
          $ip = $env:TARGET_IP
          Write-Host "Pinging node at $ip"
          tailscale ping $ip
