name: Tailscale CI

on:
  push:
    branches:
      - testing

jobs:
  tailscale-ci:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # Step 1: Connect to Tailscale using OAuth client
      - name: Tailscale Login
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          version: latest
          # Optional: ping directly after setup
          ping: PTPL-281.my-tailnet.ts.net

      # Step 2: Wait until the ephemeral node is fully online
      - name: Wait for Tailscale ephemeral node
        run: |
          $maxTries = 12
          $i = 0
          while ($i -lt $maxTries) {
            $status = tailscale status --json | ConvertFrom-Json
            if ($status.TailscaleNodeState -eq "Running") { break }
            Write-Host "Waiting for Tailscale to start..."
            Start-Sleep -Seconds 5
            $i++
          }

      # Step 3: Ping PTPL-281 by name or fallback to IP
      - name: Ping PTPL-281
        run: |
          # Try DNS first
          try {
            tailscale ping PTPL-281.my-tailnet.ts.net
          } catch {
            # If DNS fails, use Tailscale IP
            $status = tailscale status --json | ConvertFrom-Json
            $node = $status.Machines | Where-Object { $_.Name -eq "PTPL-281" }
            if (-not $node) { exit 1 }
            tailscale ping $node.Addresses[0]
          }
