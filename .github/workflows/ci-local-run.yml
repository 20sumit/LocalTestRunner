name: CI - Build & Installer (GitHub Hosted)
 
on:
  push:
    branches:
      - testing

jobs:
  build-and-installer:
    name: Build and Create Installer (Windows Hosted)
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Build project (Release)
        shell: cmd
        run: |
          dotnet build LocalTestRunner.sln -c Release

      - name: List build output
        shell: cmd
        run: |
          dir bin\Release\net8.0 /s

      # Install specific version of Advanced Installer
      - name: Install Advanced Installer 22.9.1 (Chocolatey)
        shell: powershell
        run: |
          choco install advanced-installer --version=22.9.1 --yes --no-progress

      # Activate Advanced Installer license
      - name: Activate Advanced Installer License
        shell: cmd
        env:
          AI_LICENSE_KEY: ${{ secrets.ADVANCED_INSTALLER_LICENSE_KEY }}
        run: |
          "C:\Program Files (x86)\Caphyon\Advanced Installer 22.9.1\bin\x86\AdvancedInstaller.com" /Register %AI_LICENSE_KEY%

      # Prepare installer bin folder
      - name: Prepare installer bin folder
        shell: cmd
        run: |
          if exist installer_bin rmdir /s /q installer_bin
          mkdir installer_bin
          xcopy bin\Release\net8.0\* installer_bin\ /e /i /y

      # Build installer
      - name: Build installer
        shell: cmd
        run: |
          "C:\Program Files (x86)\Caphyon\Advanced Installer 22.9.1\bin\x86\AdvancedInstaller.com" ^
            /build "Advanced Installer\Projects\Vm Testing\Vm Testing.aip"

      # Upload installer artifact
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: Advanced Installer\Projects\Vm Testing\Setup Files\*.exe
