name: WireGuard VPN Client Test

on:
  workflow_dispatch:
  push:
    branches:
      - testing

jobs:
  vpn:
    runs-on: windows-latest

    steps:
      # Step 1: Install WireGuard using Chocolatey
      - name: Install WireGuard
        shell: powershell
        run: |
          choco install wireguard -y
          # Wait a few seconds to ensure installation completes
          Start-Sleep -Seconds 5

      # Step 2: Configure VPN client
      - name: Configure WireGuard VPN
        shell: powershell
        run: |
          # Save private key to file
          $wgKey = "${{ secrets.WG_PRIVATE_KEY }}"
          $wgKey | Out-File -Encoding ASCII privatekey

          # Path to wg.exe
          $wgPath = "C:\Program Files\WireGuard\wg.exe"

          # Bring up the client interface
          & "$wgPath" set wg0 `
            private-key privatekey `
            peer ${{ secrets.WG_SERVER_PUBLIC_KEY }} `
            endpoint ${{ secrets.WG_SERVER_ENDPOINT }} `
            allowed-ips ${{ secrets.WG_ALLOWED_IPS }} `
            persistent-keepalive 25

      # Step 3: Verify VPN connection
      - name: Verify VPN
        shell: powershell
        run: |
          $wgPath = "C:\Program Files\WireGuard\wg.exe"
          & "$wgPath" show
          ipconfig

      # Step 4: Test private network access
      - name: Test private network access
        shell: powershell
        run: |
          # Ping an internal server on your private network
          Test-Connection 192.168.1.10 -Count 2
          # Example: Access a web service on the private network
          Invoke-WebRequest http://192.168.1.10:8080

      # Step 5: Tear down VPN (cleanup)
      - name: Tear down VPN
        if: always()
        shell: powershell
        run: |
          $wgPath = "C:\Program Files\WireGuard\wg.exe"
          & "$wgPath" down wg0
