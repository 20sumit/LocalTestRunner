name: Tailscale CI (OAuth)

on:
  push:
    branches:
      - testing

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # Step 1: Connect to Tailscale using OAuth token
      

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
            oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
            oauth-client-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
            tags: tag:ci

      # Step 2: Wait until Tailscale is fully connected
      - name: Wait for Tailscale
        run: |
          $maxTries = 10
          $i = 0
          while ($i -lt $maxTries) {
            $status = tailscale status --json | ConvertFrom-Json
            if ($status.TailscaleNodeState -eq "Running") { break }
            Write-Host "Waiting for Tailscale to start..."
            Start-Sleep -Seconds 5
            $i++
          }

      # Step 3: Get PTPL-281 IP address
      - name: Get PTPL-281 IP
        run: |
          $targetName = "PTPL-281"
          $status = tailscale status --json | ConvertFrom-Json
          $node = $status.Machines | Where-Object { $_.Name -eq $targetName }
          if (-not $node) { 
            Write-Host "Node $targetName not found!"
            exit 1
          }
          $ip = $node.Addresses[0]
          Write-Host "Node IP: $ip"
          echo "TARGET_IP=$ip" >> $env:GITHUB_ENV

      # Step 4: Ping the node
      - name: Ping PTPL-281
        run: |
          tailscale ping $env:TARGET_IP
