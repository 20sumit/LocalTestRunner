name: CI - Build & Installer on Self-Hosted Runner

on:
  push:
    branches:
      - testing

jobs:
  build-and-installer:
    name: Build and Create Installer (Self-Hosted)
    runs-on: [self-hosted, Windows, X64]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build project (Release)
        shell: cmd
        run: |
          "C:\Program Files\dotnet\dotnet.exe" build LocalTestRunner.sln -c Release

      - name: List build output
        shell: cmd
        run: |
          dir bin\Release\net8.0 /s

      - name: Clean installer bin folder
        shell: pwsh
        run: |
          Remove-Item 'E:\test\bin\*' -Recurse -Force -ErrorAction SilentlyContinue

      - name: Copy binaries to installer bin
        shell: pwsh
        run: |
          Copy-Item `
            -Path 'bin\Release\net8.0\*' `
            -Destination 'E:\test\bin' `
            -Recurse -Force

      - name: Build installer
        shell: pwsh
        run: |
          $aiPath = "C:\Program Files (x86)\Caphyon\Advanced Installer 22.9.1\bin\x86\AdvancedInstaller.com"
          $projectPath = "E:\test\VM.aip"
          & "$aiPath" /build "$projectPath"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: E:\test\Setup Files\*.exe
