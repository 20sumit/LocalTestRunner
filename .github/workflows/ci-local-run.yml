name: WireGuard + Build + Advanced Installer Floating License Check

on:
  push:
    branches:
      - testing
  workflow_dispatch:

jobs:
  wireguard_example:
    runs-on: windows-latest

    steps:
      # 1) Checkout repository
      - name: Checkout source
        uses: actions/checkout@v4

      # 2) Build .NET solution
      - name: Build project (Release )
        shell: cmd
        run: |
          "C:\Program Files\dotnet\dotnet.exe" build LocalTestRunner.sln -c Release

      - name: List all files in workspace
        shell: pwsh
        run: |
          Write-Output "================ WORKSPACE FILE LIST ================"

          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse |
            Select-Object FullName, Length |
            Format-Table -AutoSize

          Write-Output "====================================================="

      # 3) Install Advanced Installer (23.4)
      - name: Install Advanced Installer
        uses: Caphyon/advinst-github-action@main
        with:
          advinst-version: '23.4'

      # 4) Verify Advanced Installer is available
      - name: Verify Advanced Installer
        shell: pwsh
        run: |
          if (-not (Get-Command AdvancedInstaller.com -ErrorAction SilentlyContinue)) {
            Write-Error "AdvancedInstaller.com not found in PATH"
            exit 1
          }

          AdvancedInstaller.com /version
          AdvancedInstaller.com /help
          Write-Output "Advanced Installer is installed and ready."

      # 5) Install WireGuard
      - name: Install WireGuard
        shell: pwsh
        run: |
          $url = "https://download.wireguard.com/windows-client/wireguard-installer.exe"
          $installerPath = "$env:TEMP\wireguard-installer.exe"

          Invoke-WebRequest -Uri $url -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow

          if (!(Test-Path "C:\Program Files\WireGuard\wireguard.exe")) {
            Write-Error "WireGuard installation failed"
            exit 1
          }

      # 6) Write WireGuard configuration file
      - name: Write WireGuard config file
        shell: pwsh
        run: |
          $configContent = @"
          [Interface]
          PrivateKey = ${{ secrets.WIREGUARD_PRIVATE_KEY }}
          Address = 10.0.0.2/24
          DNS = 8.8.8.8, 8.8.4.4

          [Peer]
          PublicKey = gTecIYqs7cW7SyHzS3lwy7MK/Lf9G0MxYg2YhAN90lw=
          AllowedIPs = 0.0.0.0/0
          Endpoint = 114.143.100.202:51820
          PersistentKeepalive = 25
          "@

          $configPath = "$env:TEMP\wg0.conf"
          Set-Content -Path $configPath -Value $configContent -Encoding UTF8

      # 7) Start WireGuard tunnel
  

      # 8) Check floating license server
      - name: Check Advanced Installer floating license
        shell: pwsh
        run: |
            Write-Output "================ Floating License Check ================"

            if (-not (Get-Command AdvancedInstaller.com -ErrorAction SilentlyContinue)) {
              Write-Error "AdvancedInstaller.com not found in PATH"
              exit 1
            }

            # Run floating license test and capture output
            $output = & AdvancedInstaller.com /registerfloating 172.16.2.20:8080 -testconnection 2>&1
            $exitCode = $LASTEXITCODE

            Write-Output "----- Advanced Installer Output -----"
            $output | ForEach-Object { Write-Output $_ }
            Write-Output "-------------------------------------"

            Write-Output "Exit code: $exitCode"

            if ($exitCode -eq 0) {
              Write-Output " SUCCESS: Floating license server reachable and slot available"
            } else {
              Write-Warning " FAILURE: No license slot available or server unreachable"
            }

            Write-Output ""
            Write-Output "================ TCP Connectivity Check ================"

            try {
              $tcp = New-Object System.Net.Sockets.TcpClient("172.16.2.20", 8080)
              Write-Output " TCP connect SUCCESS (172.16.2.20:8080)"
              $tcp.Close()
            } catch {
              Write-Warning " TCP connect FAILED: $($_.Exception.Message)"
            }



      # 9) Stop and uninstall WireGuard tunnel (always runs)
      - name: Stop and uninstall WireGuard tunnel
        if: always()
        shell: pwsh
        run: |
          $wgExe = "C:\Program Files\WireGuard\wireguard.exe"

          if (Test-Path $wgExe) {
            & $wgExe /uninstalltunnelservice wg0
            Write-Output "WireGuard tunnel wg0 removed"
          }
